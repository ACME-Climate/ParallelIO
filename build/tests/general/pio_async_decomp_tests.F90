! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/tkurc/codar/e3sm/pio_adios1/ParallelIO/tests/general/pio_async_decomp_tests.F90.in

! Split comm world into n disjoint comms
! The processes are divided evenly across the n comms
! gcomm_idx is a global index (among the comms) of the new_comm
! Note: The function assumes that there are atleast ncomms
! procs
SUBROUTINE split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests.F90.in:6
  use mpi   ! pio_async_decomp_tests.F90.in:7
  use pio_tutil   ! pio_async_decomp_tests.F90.in:8
  implicit none   ! pio_async_decomp_tests.F90.in:9
  integer, intent(inout) :: ncomms   ! pio_async_decomp_tests.F90.in:10
  integer, intent(inout) :: new_comm   ! pio_async_decomp_tests.F90.in:11
  integer, intent(inout) :: new_rank   ! pio_async_decomp_tests.F90.in:12
  integer, intent(inout) :: new_size   ! pio_async_decomp_tests.F90.in:13
  integer, intent(inout) :: gcomm_idx   ! pio_async_decomp_tests.F90.in:14


  integer :: nprocs_per_comm   ! pio_async_decomp_tests.F90.in:16
  logical :: is_last_comm   ! pio_async_decomp_tests.F90.in:17
  integer :: ierr   ! pio_async_decomp_tests.F90.in:18
  integer :: color   ! pio_async_decomp_tests.F90.in:19


  new_comm = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:21
  new_rank = 0   ! pio_async_decomp_tests.F90.in:22
  new_size = 0   ! pio_async_decomp_tests.F90.in:23
  gcomm_idx = 0   ! pio_async_decomp_tests.F90.in:24


  ! We need at least one proc in each disjoint comm
  if(pio_tf_world_sz_ < ncomms) then   ! pio_async_decomp_tests.F90.in:27
    return   ! pio_async_decomp_tests.F90.in:28
  end if   ! pio_async_decomp_tests.F90.in:29


  nprocs_per_comm = pio_tf_world_sz_/ncomms   ! pio_async_decomp_tests.F90.in:31
  is_last_comm = .false.   ! pio_async_decomp_tests.F90.in:32
  if(pio_tf_world_rank_ >= nprocs_per_comm * (ncomms - 1)) then   ! pio_async_decomp_tests.F90.in:33
    is_last_comm = .true.   ! pio_async_decomp_tests.F90.in:34
  end if   ! pio_async_decomp_tests.F90.in:35


  color = pio_tf_world_rank_/nprocs_per_comm   ! pio_async_decomp_tests.F90.in:37
  ! Make sure that every proc in the last set (all remaining procs
  ! are included in the last set/comm) gets the same color
  if(is_last_comm) then   ! pio_async_decomp_tests.F90.in:40
    color = ncomms - 1   ! pio_async_decomp_tests.F90.in:41
  end if   ! pio_async_decomp_tests.F90.in:42
  gcomm_idx = color + 1   ! pio_async_decomp_tests.F90.in:43


  call MPI_Comm_split(pio_tf_comm_, color, 0, new_comm, ierr)   ! pio_async_decomp_tests.F90.in:45


  call MPI_Comm_size(new_comm, new_size, ierr)   ! pio_async_decomp_tests.F90.in:47
  call MPI_Comm_rank(new_comm, new_rank, ierr)   ! pio_async_decomp_tests.F90.in:48
END SUBROUTINE split_world_ncomms   ! pio_async_decomp_tests.F90.in:49


! Async I/O as service test with 2 compute comms and 1 io comm
! The test creates 1d decomps for each of the compute procs


SUBROUTINE async_2comp_iodesc_1d_PIO_int_integer__
USE pio_tutil
   ! pio_async_decomp_tests.F90.in:54
  use mpi   ! pio_async_decomp_tests.F90.in:55
  implicit none   ! pio_async_decomp_tests.F90.in:56
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests.F90.in:58
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:60
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:62
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:63
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:64
  integer :: new_comm, io_comm   ! pio_async_decomp_tests.F90.in:65
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests.F90.in:66
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests.F90.in:69
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests.F90.in:71
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests.F90.in:72
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests.F90.in:73
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests.F90.in:74
   ! pio_async_decomp_tests.F90.in:75
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests.F90.in:77
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests.F90.in:78
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests.F90.in:79
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests.F90.in:80
   ! pio_async_decomp_tests.F90.in:81
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests.F90.in:82
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests.F90.in:83
  integer :: dims(NUM_DIMS)   ! pio_async_decomp_tests.F90.in:84
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests.F90.in:85
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests.F90.in:86
   ! pio_async_decomp_tests.F90.in:87
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests.F90.in:88
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests.F90.in:89
  integer :: num_iotypes = 0   ! pio_async_decomp_tests.F90.in:90
   ! pio_async_decomp_tests.F90.in:91
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests.F90.in:92
   ! pio_async_decomp_tests.F90.in:93
  num_iotypes = 0   ! pio_async_decomp_tests.F90.in:94
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests.F90.in:95
   ! pio_async_decomp_tests.F90.in:96
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests.F90.in:97
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests.F90.in:98
  end do   ! pio_async_decomp_tests.F90.in:99
   ! pio_async_decomp_tests.F90.in:100
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests.F90.in:101

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests.F90.in:102
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests.F90.in:103
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests.F90.in:105
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests.F90.in:107
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:108
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:109
      end do   ! pio_async_decomp_tests.F90.in:110
   ! pio_async_decomp_tests.F90.in:111
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests.F90.in:113
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests.F90.in:114
        is_io = .true.   ! pio_async_decomp_tests.F90.in:115
      end if   ! pio_async_decomp_tests.F90.in:116
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests.F90.in:117
   ! pio_async_decomp_tests.F90.in:118
      if(is_io) then   ! pio_async_decomp_tests.F90.in:119
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests.F90.in:121
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:122
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:123
      else   ! pio_async_decomp_tests.F90.in:124
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests.F90.in:126
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:127
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:128
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:129
   ! pio_async_decomp_tests.F90.in:130
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests.F90.in:132
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests.F90.in:133
   ! pio_async_decomp_tests.F90.in:134
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_int, dims, compdof, iodesc)   ! pio_async_decomp_tests.F90.in:138
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests.F90.in:140
   ! pio_async_decomp_tests.F90.in:141
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:142
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests.F90.in:143
        end do   ! pio_async_decomp_tests.F90.in:144
      end if   ! pio_async_decomp_tests.F90.in:145
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests.F90.in:146
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests.F90.in:147)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests.F90.in:147
    end if   ! pio_async_decomp_tests.F90.in:148
  end do   ! pio_async_decomp_tests.F90.in:149
END SUBROUTINE async_2comp_iodesc_1d_PIO_int_integer__   ! pio_async_decomp_tests.F90.in:150


SUBROUTINE async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___
USE pio_tutil
   ! pio_async_decomp_tests.F90.in:54
  use mpi   ! pio_async_decomp_tests.F90.in:55
  implicit none   ! pio_async_decomp_tests.F90.in:56
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests.F90.in:58
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:60
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:62
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:63
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:64
  integer :: new_comm, io_comm   ! pio_async_decomp_tests.F90.in:65
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests.F90.in:66
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests.F90.in:69
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests.F90.in:71
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests.F90.in:72
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests.F90.in:73
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests.F90.in:74
   ! pio_async_decomp_tests.F90.in:75
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests.F90.in:77
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests.F90.in:78
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests.F90.in:79
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests.F90.in:80
   ! pio_async_decomp_tests.F90.in:81
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests.F90.in:82
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests.F90.in:83
  integer :: dims(NUM_DIMS)   ! pio_async_decomp_tests.F90.in:84
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests.F90.in:85
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests.F90.in:86
   ! pio_async_decomp_tests.F90.in:87
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests.F90.in:88
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests.F90.in:89
  integer :: num_iotypes = 0   ! pio_async_decomp_tests.F90.in:90
   ! pio_async_decomp_tests.F90.in:91
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests.F90.in:92
   ! pio_async_decomp_tests.F90.in:93
  num_iotypes = 0   ! pio_async_decomp_tests.F90.in:94
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests.F90.in:95
   ! pio_async_decomp_tests.F90.in:96
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests.F90.in:97
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests.F90.in:98
  end do   ! pio_async_decomp_tests.F90.in:99
   ! pio_async_decomp_tests.F90.in:100
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests.F90.in:101

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests.F90.in:102
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests.F90.in:103
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests.F90.in:105
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests.F90.in:107
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:108
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:109
      end do   ! pio_async_decomp_tests.F90.in:110
   ! pio_async_decomp_tests.F90.in:111
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests.F90.in:113
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests.F90.in:114
        is_io = .true.   ! pio_async_decomp_tests.F90.in:115
      end if   ! pio_async_decomp_tests.F90.in:116
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests.F90.in:117
   ! pio_async_decomp_tests.F90.in:118
      if(is_io) then   ! pio_async_decomp_tests.F90.in:119
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests.F90.in:121
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:122
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:123
      else   ! pio_async_decomp_tests.F90.in:124
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests.F90.in:126
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:127
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:128
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:129
   ! pio_async_decomp_tests.F90.in:130
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests.F90.in:132
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests.F90.in:133
   ! pio_async_decomp_tests.F90.in:134
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_real, dims, compdof, iodesc)   ! pio_async_decomp_tests.F90.in:138
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests.F90.in:140
   ! pio_async_decomp_tests.F90.in:141
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:142
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests.F90.in:143
        end do   ! pio_async_decomp_tests.F90.in:144
      end if   ! pio_async_decomp_tests.F90.in:145
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests.F90.in:146
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests.F90.in:147)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests.F90.in:147
    end if   ! pio_async_decomp_tests.F90.in:148
  end do   ! pio_async_decomp_tests.F90.in:149
END SUBROUTINE async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___   ! pio_async_decomp_tests.F90.in:150


SUBROUTINE async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___
USE pio_tutil
   ! pio_async_decomp_tests.F90.in:54
  use mpi   ! pio_async_decomp_tests.F90.in:55
  implicit none   ! pio_async_decomp_tests.F90.in:56
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests.F90.in:58
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:60
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests.F90.in:62
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:63
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests.F90.in:64
  integer :: new_comm, io_comm   ! pio_async_decomp_tests.F90.in:65
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests.F90.in:66
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests.F90.in:69
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests.F90.in:71
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests.F90.in:72
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests.F90.in:73
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests.F90.in:74
   ! pio_async_decomp_tests.F90.in:75
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests.F90.in:77
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests.F90.in:78
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests.F90.in:79
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests.F90.in:80
   ! pio_async_decomp_tests.F90.in:81
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests.F90.in:82
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests.F90.in:83
  integer :: dims(NUM_DIMS)   ! pio_async_decomp_tests.F90.in:84
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests.F90.in:85
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests.F90.in:86
   ! pio_async_decomp_tests.F90.in:87
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests.F90.in:88
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests.F90.in:89
  integer :: num_iotypes = 0   ! pio_async_decomp_tests.F90.in:90
   ! pio_async_decomp_tests.F90.in:91
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests.F90.in:92
   ! pio_async_decomp_tests.F90.in:93
  num_iotypes = 0   ! pio_async_decomp_tests.F90.in:94
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests.F90.in:95
   ! pio_async_decomp_tests.F90.in:96
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests.F90.in:97
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests.F90.in:98
  end do   ! pio_async_decomp_tests.F90.in:99
   ! pio_async_decomp_tests.F90.in:100
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests.F90.in:101

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests.F90.in:102
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests.F90.in:103
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests.F90.in:105
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests.F90.in:107
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:108
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:109
      end do   ! pio_async_decomp_tests.F90.in:110
   ! pio_async_decomp_tests.F90.in:111
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests.F90.in:113
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests.F90.in:114
        is_io = .true.   ! pio_async_decomp_tests.F90.in:115
      end if   ! pio_async_decomp_tests.F90.in:116
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests.F90.in:117
   ! pio_async_decomp_tests.F90.in:118
      if(is_io) then   ! pio_async_decomp_tests.F90.in:119
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests.F90.in:121
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:122
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:123
      else   ! pio_async_decomp_tests.F90.in:124
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests.F90.in:126
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests.F90.in:127
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests.F90.in:128
              iosys, rearrs(i))   ! pio_async_decomp_tests.F90.in:129
   ! pio_async_decomp_tests.F90.in:130
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests.F90.in:132
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests.F90.in:133
   ! pio_async_decomp_tests.F90.in:134
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_double, dims, compdof, iodesc)   ! pio_async_decomp_tests.F90.in:138
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests.F90.in:140
   ! pio_async_decomp_tests.F90.in:141
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests.F90.in:142
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests.F90.in:143
        end do   ! pio_async_decomp_tests.F90.in:144
      end if   ! pio_async_decomp_tests.F90.in:145
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests.F90.in:146
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests.F90.in:147)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests.F90.in:147
    end if   ! pio_async_decomp_tests.F90.in:148
  end do   ! pio_async_decomp_tests.F90.in:149
END SUBROUTINE async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___   ! pio_async_decomp_tests.F90.in:150
   ! pio_async_decomp_tests.F90.in:150




  SUBROUTINE PIO_TF_Test_driver_
    USE pio_tutil
    IMPLICIT NONE
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_iodesc_1d_PIO_int_integer__"
    END IF
    CALL async_2comp_iodesc_1d_PIO_int_integer__()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "async_2comp_iodesc_1d_PIO_int_integer__","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "async_2comp_iodesc_1d_PIO_int_integer__","-----------", "FAILED"
      END IF
    END IF
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___"
    END IF
    CALL async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "async_2comp_iodesc_1d_PIO_real_real_kind_fc_real___","-----------", "FAILED"
      END IF
    END IF
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___"
    END IF
    CALL async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          "async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          "async_2comp_iodesc_1d_PIO_double_real_kind_fc_double___","-----------", "FAILED"
      END IF
    END IF
  END SUBROUTINE PIO_TF_Test_driver_


  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
