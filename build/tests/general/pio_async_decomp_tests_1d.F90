! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/tkurc/codar/e3sm/pio_adios1/ParallelIO/tests/general/pio_async_decomp_tests_1d.F90.in

! Split comm world into n disjoint comms
! The processes are divided evenly across the n comms
! gcomm_idx is a global index (among the comms) of the new_comm
! Note: The function assumes that there are atleast ncomms
! procs
SUBROUTINE split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests_1d.F90.in:6
  use mpi   ! pio_async_decomp_tests_1d.F90.in:7
  use pio_tutil   ! pio_async_decomp_tests_1d.F90.in:8
  implicit none   ! pio_async_decomp_tests_1d.F90.in:9
  integer, intent(inout) :: ncomms   ! pio_async_decomp_tests_1d.F90.in:10
  integer, intent(inout) :: new_comm   ! pio_async_decomp_tests_1d.F90.in:11
  integer, intent(inout) :: new_rank   ! pio_async_decomp_tests_1d.F90.in:12
  integer, intent(inout) :: new_size   ! pio_async_decomp_tests_1d.F90.in:13
  integer, intent(inout) :: gcomm_idx   ! pio_async_decomp_tests_1d.F90.in:14


  integer :: nprocs_per_comm   ! pio_async_decomp_tests_1d.F90.in:16
  logical :: is_last_comm   ! pio_async_decomp_tests_1d.F90.in:17
  integer :: ierr   ! pio_async_decomp_tests_1d.F90.in:18
  integer :: color   ! pio_async_decomp_tests_1d.F90.in:19


  new_comm = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:21
  new_rank = 0   ! pio_async_decomp_tests_1d.F90.in:22
  new_size = 0   ! pio_async_decomp_tests_1d.F90.in:23
  gcomm_idx = 0   ! pio_async_decomp_tests_1d.F90.in:24


  ! We need at least one proc in each disjoint comm
  if(pio_tf_world_sz_ < ncomms) then   ! pio_async_decomp_tests_1d.F90.in:27
    return   ! pio_async_decomp_tests_1d.F90.in:28
  end if   ! pio_async_decomp_tests_1d.F90.in:29


  nprocs_per_comm = pio_tf_world_sz_/ncomms   ! pio_async_decomp_tests_1d.F90.in:31
  is_last_comm = .false.   ! pio_async_decomp_tests_1d.F90.in:32
  if(pio_tf_world_rank_ >= nprocs_per_comm * (ncomms - 1)) then   ! pio_async_decomp_tests_1d.F90.in:33
    is_last_comm = .true.   ! pio_async_decomp_tests_1d.F90.in:34
  end if   ! pio_async_decomp_tests_1d.F90.in:35


  color = pio_tf_world_rank_/nprocs_per_comm   ! pio_async_decomp_tests_1d.F90.in:37
  ! Make sure that every proc in the last set (all remaining procs
  ! are included in the last set/comm) gets the same color
  if(is_last_comm) then   ! pio_async_decomp_tests_1d.F90.in:40
    color = ncomms - 1   ! pio_async_decomp_tests_1d.F90.in:41
  end if   ! pio_async_decomp_tests_1d.F90.in:42
  gcomm_idx = color + 1   ! pio_async_decomp_tests_1d.F90.in:43


  call MPI_Comm_split(pio_tf_comm_, color, 0, new_comm, ierr)   ! pio_async_decomp_tests_1d.F90.in:45


  call MPI_Comm_size(new_comm, new_size, ierr)   ! pio_async_decomp_tests_1d.F90.in:47
  call MPI_Comm_rank(new_comm, new_rank, ierr)   ! pio_async_decomp_tests_1d.F90.in:48
END SUBROUTINE split_world_ncomms   ! pio_async_decomp_tests_1d.F90.in:49


! Async I/O as service test with 2 compute comms and 1 io comm
! The test writes data into two files, All info/data related
! to the first file is provided by the 1st compute comm and
! all info/data related to the second file is provided by the
! 2nd compute comm. Both compute comms share a single io comm


SUBROUTINE async_2comp_wr_1d_PIO_int_integer__
USE pio_tutil
   ! pio_async_decomp_tests_1d.F90.in:57
  use mpi   ! pio_async_decomp_tests_1d.F90.in:58
  implicit none   ! pio_async_decomp_tests_1d.F90.in:59
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests_1d.F90.in:61
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:63
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:65
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:66
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:67
  integer :: new_comm, io_comm   ! pio_async_decomp_tests_1d.F90.in:68
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests_1d.F90.in:69
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests_1d.F90.in:72
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:74
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests_1d.F90.in:75
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests_1d.F90.in:76
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests_1d.F90.in:77
   ! pio_async_decomp_tests_1d.F90.in:78
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests_1d.F90.in:80
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests_1d.F90.in:81
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests_1d.F90.in:82
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests_1d.F90.in:83
   ! pio_async_decomp_tests_1d.F90.in:84
  ! The size of vec/data written out from each compute proc
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests_1d.F90.in:86
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests_1d.F90.in:87
  type(var_desc_t) :: pio_var   ! pio_async_decomp_tests_1d.F90.in:88
  type(file_desc_t) :: pio_file   ! pio_async_decomp_tests_1d.F90.in:89
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests_1d.F90.in:90
  integer :: dims(NUM_DIMS), pio_dim   ! pio_async_decomp_tests_1d.F90.in:91
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:92
  integer, dimension(VEC_LOCAL_SZ) :: wbuf, rbuf   ! pio_async_decomp_tests_1d.F90.in:93
   ! pio_async_decomp_tests_1d.F90.in:94
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests_1d.F90.in:95
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests_1d.F90.in:96
  integer :: num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:97
   ! pio_async_decomp_tests_1d.F90.in:98
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests_1d.F90.in:99
   ! pio_async_decomp_tests_1d.F90.in:100
  num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:101
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests_1d.F90.in:102
   ! pio_async_decomp_tests_1d.F90.in:103
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests_1d.F90.in:104
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests_1d.F90.in:105
  end do   ! pio_async_decomp_tests_1d.F90.in:106
   ! pio_async_decomp_tests_1d.F90.in:107
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests_1d.F90.in:108

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests_1d.F90.in:109
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests_1d.F90.in:110
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests_1d.F90.in:112
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests_1d.F90.in:114
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:115
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:116
      end do   ! pio_async_decomp_tests_1d.F90.in:117
   ! pio_async_decomp_tests_1d.F90.in:118
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:120
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests_1d.F90.in:121
        is_io = .true.   ! pio_async_decomp_tests_1d.F90.in:122
      end if   ! pio_async_decomp_tests_1d.F90.in:123
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests_1d.F90.in:124
   ! pio_async_decomp_tests_1d.F90.in:125
      if(is_io) then   ! pio_async_decomp_tests_1d.F90.in:126
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests_1d.F90.in:128
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:129
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:130
      else   ! pio_async_decomp_tests_1d.F90.in:131
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests_1d.F90.in:133
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:134
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:135
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:136
   ! pio_async_decomp_tests_1d.F90.in:137
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests_1d.F90.in:139
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:140
        wbuf = pio_tf_world_rank_   ! pio_async_decomp_tests_1d.F90.in:141
   ! pio_async_decomp_tests_1d.F90.in:142
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_int, dims, compdof, iodesc)   ! pio_async_decomp_tests_1d.F90.in:146
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        do j=1,num_iotypes   ! pio_async_decomp_tests_1d.F90.in:148

          IF (pio_tf_world_rank_ == 0) THEN
            IF (pio_tf_log_level_ >= 0) THEN
              WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
              WRITE(*,*)  "Testing : PIO_int : ", iotype_descs(i)
            END IF
          END IF   ! pio_async_decomp_tests_1d.F90.in:149
   ! pio_async_decomp_tests_1d.F90.in:150
          ret = PIO_createfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_CLOBBER)   ! pio_async_decomp_tests_1d.F90.in:151
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not create file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:152)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:152
   ! pio_async_decomp_tests_1d.F90.in:153
          ret = PIO_def_dim(pio_file, trim(dimname), dims(1), pio_dim)   ! pio_async_decomp_tests_1d.F90.in:154
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define dim :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:155)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:155
   ! pio_async_decomp_tests_1d.F90.in:156
          ret = PIO_def_var(pio_file, trim(vname), PIO_int, (/pio_dim/), pio_var)    ! pio_async_decomp_tests_1d.F90.in:157
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:158)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:158
   ! pio_async_decomp_tests_1d.F90.in:159
          ret = PIO_enddef(pio_file)   ! pio_async_decomp_tests_1d.F90.in:160
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not enddef in file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:161)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:161
   ! pio_async_decomp_tests_1d.F90.in:162
          call PIO_write_darray(pio_file, pio_var, iodesc, wbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:163
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Write darray failed :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:164)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:164
   ! pio_async_decomp_tests_1d.F90.in:165
#ifdef PIO_TEST_CLOSE_OPEN_FOR_SYNC
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:167
   ! pio_async_decomp_tests_1d.F90.in:168
          ret = PIO_openfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_nowrite)   ! pio_async_decomp_tests_1d.F90.in:169
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not reopen file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:170)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:170
   ! pio_async_decomp_tests_1d.F90.in:171
          ret = PIO_inq_varid(pio_file, trim(vname), pio_var)   ! pio_async_decomp_tests_1d.F90.in:172
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not inq var:" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:173)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:173
#else
          call PIO_syncfile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:175
#endif
   ! pio_async_decomp_tests_1d.F90.in:177
          rbuf = -1   ! pio_async_decomp_tests_1d.F90.in:178
          call PIO_read_darray(pio_file, pio_var, iodesc, rbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:179
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could read var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:180)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:180
   ! pio_async_decomp_tests_1d.F90.in:181
          ! FIXME: We don't have a PIO_TF_CHECK_VAL for a comm
          !PIO_TF_CHECK_VAL((rbuf, wbuf), "Got wrong val")
          
          IF (.NOT. (ALL(rbuf == wbuf))) THEN
            pio_tf_retval_utest_ = -1
            PRINT *, "PIO_TF: Assertion failed :",&
               "Got wrong val",&
               ":", __FILE__, ":", __LINE__,&
              "(pio_async_decomp_tests_1d.F90.in:184)"
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:184
   ! pio_async_decomp_tests_1d.F90.in:185
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:186
          call PIO_deletefile(iosys(gcomp_idx), fnames(gcomp_idx))   ! pio_async_decomp_tests_1d.F90.in:187
        end do   ! pio_async_decomp_tests_1d.F90.in:188
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests_1d.F90.in:189
   ! pio_async_decomp_tests_1d.F90.in:190
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:191
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests_1d.F90.in:192
        end do   ! pio_async_decomp_tests_1d.F90.in:193
      end if   ! pio_async_decomp_tests_1d.F90.in:194
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests_1d.F90.in:195
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests_1d.F90.in:196)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests_1d.F90.in:196
    end if   ! pio_async_decomp_tests_1d.F90.in:197
  end do   ! pio_async_decomp_tests_1d.F90.in:198
END SUBROUTINE async_2comp_wr_1d_PIO_int_integer__   ! pio_async_decomp_tests_1d.F90.in:199


SUBROUTINE async_2comp_wr_1d_PIO_real_real_kind_fc_real___
USE pio_tutil
   ! pio_async_decomp_tests_1d.F90.in:57
  use mpi   ! pio_async_decomp_tests_1d.F90.in:58
  implicit none   ! pio_async_decomp_tests_1d.F90.in:59
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests_1d.F90.in:61
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:63
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:65
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:66
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:67
  integer :: new_comm, io_comm   ! pio_async_decomp_tests_1d.F90.in:68
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests_1d.F90.in:69
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests_1d.F90.in:72
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:74
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests_1d.F90.in:75
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests_1d.F90.in:76
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests_1d.F90.in:77
   ! pio_async_decomp_tests_1d.F90.in:78
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests_1d.F90.in:80
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests_1d.F90.in:81
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests_1d.F90.in:82
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests_1d.F90.in:83
   ! pio_async_decomp_tests_1d.F90.in:84
  ! The size of vec/data written out from each compute proc
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests_1d.F90.in:86
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests_1d.F90.in:87
  type(var_desc_t) :: pio_var   ! pio_async_decomp_tests_1d.F90.in:88
  type(file_desc_t) :: pio_file   ! pio_async_decomp_tests_1d.F90.in:89
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests_1d.F90.in:90
  integer :: dims(NUM_DIMS), pio_dim   ! pio_async_decomp_tests_1d.F90.in:91
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:92
  real(kind=fc_real), dimension(VEC_LOCAL_SZ) :: wbuf, rbuf   ! pio_async_decomp_tests_1d.F90.in:93
   ! pio_async_decomp_tests_1d.F90.in:94
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests_1d.F90.in:95
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests_1d.F90.in:96
  integer :: num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:97
   ! pio_async_decomp_tests_1d.F90.in:98
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests_1d.F90.in:99
   ! pio_async_decomp_tests_1d.F90.in:100
  num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:101
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests_1d.F90.in:102
   ! pio_async_decomp_tests_1d.F90.in:103
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests_1d.F90.in:104
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests_1d.F90.in:105
  end do   ! pio_async_decomp_tests_1d.F90.in:106
   ! pio_async_decomp_tests_1d.F90.in:107
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests_1d.F90.in:108

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests_1d.F90.in:109
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests_1d.F90.in:110
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests_1d.F90.in:112
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests_1d.F90.in:114
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:115
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:116
      end do   ! pio_async_decomp_tests_1d.F90.in:117
   ! pio_async_decomp_tests_1d.F90.in:118
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:120
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests_1d.F90.in:121
        is_io = .true.   ! pio_async_decomp_tests_1d.F90.in:122
      end if   ! pio_async_decomp_tests_1d.F90.in:123
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests_1d.F90.in:124
   ! pio_async_decomp_tests_1d.F90.in:125
      if(is_io) then   ! pio_async_decomp_tests_1d.F90.in:126
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests_1d.F90.in:128
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:129
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:130
      else   ! pio_async_decomp_tests_1d.F90.in:131
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests_1d.F90.in:133
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:134
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:135
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:136
   ! pio_async_decomp_tests_1d.F90.in:137
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests_1d.F90.in:139
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:140
        wbuf = pio_tf_world_rank_   ! pio_async_decomp_tests_1d.F90.in:141
   ! pio_async_decomp_tests_1d.F90.in:142
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_real, dims, compdof, iodesc)   ! pio_async_decomp_tests_1d.F90.in:146
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        do j=1,num_iotypes   ! pio_async_decomp_tests_1d.F90.in:148

          IF (pio_tf_world_rank_ == 0) THEN
            IF (pio_tf_log_level_ >= 0) THEN
              WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
              WRITE(*,*)  "Testing : PIO_real : ", iotype_descs(i)
            END IF
          END IF   ! pio_async_decomp_tests_1d.F90.in:149
   ! pio_async_decomp_tests_1d.F90.in:150
          ret = PIO_createfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_CLOBBER)   ! pio_async_decomp_tests_1d.F90.in:151
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not create file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:152)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:152
   ! pio_async_decomp_tests_1d.F90.in:153
          ret = PIO_def_dim(pio_file, trim(dimname), dims(1), pio_dim)   ! pio_async_decomp_tests_1d.F90.in:154
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define dim :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:155)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:155
   ! pio_async_decomp_tests_1d.F90.in:156
          ret = PIO_def_var(pio_file, trim(vname), PIO_real, (/pio_dim/), pio_var)    ! pio_async_decomp_tests_1d.F90.in:157
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:158)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:158
   ! pio_async_decomp_tests_1d.F90.in:159
          ret = PIO_enddef(pio_file)   ! pio_async_decomp_tests_1d.F90.in:160
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not enddef in file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:161)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:161
   ! pio_async_decomp_tests_1d.F90.in:162
          call PIO_write_darray(pio_file, pio_var, iodesc, wbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:163
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Write darray failed :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:164)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:164
   ! pio_async_decomp_tests_1d.F90.in:165
#ifdef PIO_TEST_CLOSE_OPEN_FOR_SYNC
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:167
   ! pio_async_decomp_tests_1d.F90.in:168
          ret = PIO_openfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_nowrite)   ! pio_async_decomp_tests_1d.F90.in:169
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not reopen file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:170)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:170
   ! pio_async_decomp_tests_1d.F90.in:171
          ret = PIO_inq_varid(pio_file, trim(vname), pio_var)   ! pio_async_decomp_tests_1d.F90.in:172
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not inq var:" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:173)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:173
#else
          call PIO_syncfile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:175
#endif
   ! pio_async_decomp_tests_1d.F90.in:177
          rbuf = -1   ! pio_async_decomp_tests_1d.F90.in:178
          call PIO_read_darray(pio_file, pio_var, iodesc, rbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:179
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could read var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:180)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:180
   ! pio_async_decomp_tests_1d.F90.in:181
          ! FIXME: We don't have a PIO_TF_CHECK_VAL for a comm
          !PIO_TF_CHECK_VAL((rbuf, wbuf), "Got wrong val")
          
          IF (.NOT. (ALL(rbuf == wbuf))) THEN
            pio_tf_retval_utest_ = -1
            PRINT *, "PIO_TF: Assertion failed :",&
               "Got wrong val",&
               ":", __FILE__, ":", __LINE__,&
              "(pio_async_decomp_tests_1d.F90.in:184)"
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:184
   ! pio_async_decomp_tests_1d.F90.in:185
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:186
          call PIO_deletefile(iosys(gcomp_idx), fnames(gcomp_idx))   ! pio_async_decomp_tests_1d.F90.in:187
        end do   ! pio_async_decomp_tests_1d.F90.in:188
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests_1d.F90.in:189
   ! pio_async_decomp_tests_1d.F90.in:190
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:191
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests_1d.F90.in:192
        end do   ! pio_async_decomp_tests_1d.F90.in:193
      end if   ! pio_async_decomp_tests_1d.F90.in:194
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests_1d.F90.in:195
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests_1d.F90.in:196)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests_1d.F90.in:196
    end if   ! pio_async_decomp_tests_1d.F90.in:197
  end do   ! pio_async_decomp_tests_1d.F90.in:198
END SUBROUTINE async_2comp_wr_1d_PIO_real_real_kind_fc_real___   ! pio_async_decomp_tests_1d.F90.in:199


SUBROUTINE async_2comp_wr_1d_PIO_double_real_kind_fc_double___
USE pio_tutil
   ! pio_async_decomp_tests_1d.F90.in:57
  use mpi   ! pio_async_decomp_tests_1d.F90.in:58
  implicit none   ! pio_async_decomp_tests_1d.F90.in:59
  ! Number of compute components
  integer, parameter :: NUM_COMPONENTS = 2   ! pio_async_decomp_tests_1d.F90.in:61
  ! Total number of comms = comms for each of NUM_COMPONENTS + io comm
  integer :: ncomms = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:63
  ! We need to have at least one proc in each of comm
  integer, parameter :: MIN_NUM_PROCS = NUM_COMPONENTS + 1   ! pio_async_decomp_tests_1d.F90.in:65
  integer :: comp_comms(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:66
  type(iosystem_desc_t) :: iosys(NUM_COMPONENTS)   ! pio_async_decomp_tests_1d.F90.in:67
  integer :: new_comm, io_comm   ! pio_async_decomp_tests_1d.F90.in:68
  integer :: new_rank, new_size, i, j   ! pio_async_decomp_tests_1d.F90.in:69
  ! gcomm_idx => Global index for the MPI comms
  ! gcomp_idx => Global index for the compute components
  integer :: gcomm_idx, gcomp_idx   ! pio_async_decomp_tests_1d.F90.in:72
  ! is_io == .true. if proc is part of the io comp
  logical :: is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:74
  integer, parameter :: NUM_REARRANGERS = 2   ! pio_async_decomp_tests_1d.F90.in:75
  integer :: rearrs(NUM_REARRANGERS) = (/pio_rearr_subset,pio_rearr_box/)   ! pio_async_decomp_tests_1d.F90.in:76
  character(len=PIO_TF_MAX_STR_LEN) :: rearrs_info(NUM_REARRANGERS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)   ! pio_async_decomp_tests_1d.F90.in:77
   ! pio_async_decomp_tests_1d.F90.in:78
  ! file1 is written out by comp1 and file2 is written out by comp2
  character(len=PIO_TF_MAX_STR_LEN) :: fnames(NUM_COMPONENTS) = (/"pio_async_decomp_tests_file_comp1.nc","pio_async_decomp_tests_file_comp2.nc"/)   ! pio_async_decomp_tests_1d.F90.in:80
  character(len=PIO_TF_MAX_STR_LEN) :: attname = "filename"   ! pio_async_decomp_tests_1d.F90.in:81
  character(len=PIO_TF_MAX_STR_LEN) :: dimname = "PIO_TF_test_dim"   ! pio_async_decomp_tests_1d.F90.in:82
  character(len=PIO_TF_MAX_STR_LEN) :: vname = "PIO_TF_test_var"   ! pio_async_decomp_tests_1d.F90.in:83
   ! pio_async_decomp_tests_1d.F90.in:84
  ! The size of vec/data written out from each compute proc
  integer, parameter :: VEC_LOCAL_SZ = 7   ! pio_async_decomp_tests_1d.F90.in:86
  integer, parameter :: NUM_DIMS = 1   ! pio_async_decomp_tests_1d.F90.in:87
  type(var_desc_t) :: pio_var   ! pio_async_decomp_tests_1d.F90.in:88
  type(file_desc_t) :: pio_file   ! pio_async_decomp_tests_1d.F90.in:89
  type(io_desc_t) :: iodesc   ! pio_async_decomp_tests_1d.F90.in:90
  integer :: dims(NUM_DIMS), pio_dim   ! pio_async_decomp_tests_1d.F90.in:91
  integer, dimension(VEC_LOCAL_SZ) :: compdof, compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:92
  real(kind=fc_double), dimension(VEC_LOCAL_SZ) :: wbuf, rbuf   ! pio_async_decomp_tests_1d.F90.in:93
   ! pio_async_decomp_tests_1d.F90.in:94
  integer, dimension(:), allocatable :: iotypes   ! pio_async_decomp_tests_1d.F90.in:95
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_async_decomp_tests_1d.F90.in:96
  integer :: num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:97
   ! pio_async_decomp_tests_1d.F90.in:98
  integer :: ret = PIO_NOERR   ! pio_async_decomp_tests_1d.F90.in:99
   ! pio_async_decomp_tests_1d.F90.in:100
  num_iotypes = 0   ! pio_async_decomp_tests_1d.F90.in:101
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_async_decomp_tests_1d.F90.in:102
   ! pio_async_decomp_tests_1d.F90.in:103
  do i=1,VEC_LOCAL_SZ   ! pio_async_decomp_tests_1d.F90.in:104
    compdof_rel_disps(i) = i   ! pio_async_decomp_tests_1d.F90.in:105
  end do   ! pio_async_decomp_tests_1d.F90.in:106
   ! pio_async_decomp_tests_1d.F90.in:107
  do i=1,NUM_REARRANGERS   ! pio_async_decomp_tests_1d.F90.in:108

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing rearr : ", trim(rearrs_info(i))
      END IF
    END IF   ! pio_async_decomp_tests_1d.F90.in:109
    if(pio_tf_world_sz_ >= MIN_NUM_PROCS) then   ! pio_async_decomp_tests_1d.F90.in:110
      ! Create three disjoint sets of IO procs and compute procs
      call split_world_ncomms(ncomms, new_comm, new_rank, new_size, gcomm_idx)   ! pio_async_decomp_tests_1d.F90.in:112
      !print *, "Split new comm, size = ", new_size, ", rank = ", new_rank, ", gcomm_idx = ", gcomm_idx 
   ! pio_async_decomp_tests_1d.F90.in:114
      do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:115
        comp_comms(j) = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:116
      end do   ! pio_async_decomp_tests_1d.F90.in:117
   ! pio_async_decomp_tests_1d.F90.in:118
      ! Use first comm as the IO proc
      is_io = .false.   ! pio_async_decomp_tests_1d.F90.in:120
      if(gcomm_idx == 1) then   ! pio_async_decomp_tests_1d.F90.in:121
        is_io = .true.   ! pio_async_decomp_tests_1d.F90.in:122
      end if   ! pio_async_decomp_tests_1d.F90.in:123
      gcomp_idx = gcomm_idx - 1   ! pio_async_decomp_tests_1d.F90.in:124
   ! pio_async_decomp_tests_1d.F90.in:125
      if(is_io) then   ! pio_async_decomp_tests_1d.F90.in:126
        ! I/O proc
        io_comm = new_comm   ! pio_async_decomp_tests_1d.F90.in:128
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:129
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:130
      else   ! pio_async_decomp_tests_1d.F90.in:131
        ! Compute proc
        comp_comms(gcomp_idx) = new_comm   ! pio_async_decomp_tests_1d.F90.in:133
        io_comm = MPI_COMM_NULL   ! pio_async_decomp_tests_1d.F90.in:134
        call PIO_init(NUM_COMPONENTS, pio_tf_comm_, comp_comms, io_comm,&   ! pio_async_decomp_tests_1d.F90.in:135
              iosys, rearrs(i))   ! pio_async_decomp_tests_1d.F90.in:136
   ! pio_async_decomp_tests_1d.F90.in:137
        ! Only compute procs send data 
        dims(1) = VEC_LOCAL_SZ * new_size   ! pio_async_decomp_tests_1d.F90.in:139
        compdof = VEC_LOCAL_SZ * new_rank + compdof_rel_disps   ! pio_async_decomp_tests_1d.F90.in:140
        wbuf = pio_tf_world_rank_   ! pio_async_decomp_tests_1d.F90.in:141
   ! pio_async_decomp_tests_1d.F90.in:142
        ! Only compute procs call PIO function calls, I/O proc
        ! waits inside PIO_init() waiting for commands from the
        ! compute processes
        call PIO_initdecomp(iosys(gcomp_idx), PIO_double, dims, compdof, iodesc)   ! pio_async_decomp_tests_1d.F90.in:146
        !print *, "iosys idx = ", gcomp_idx, " = ", iosys(gcomp_idx)
        do j=1,num_iotypes   ! pio_async_decomp_tests_1d.F90.in:148

          IF (pio_tf_world_rank_ == 0) THEN
            IF (pio_tf_log_level_ >= 0) THEN
              WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
              WRITE(*,*)  "Testing : PIO_double : ", iotype_descs(i)
            END IF
          END IF   ! pio_async_decomp_tests_1d.F90.in:149
   ! pio_async_decomp_tests_1d.F90.in:150
          ret = PIO_createfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_CLOBBER)   ! pio_async_decomp_tests_1d.F90.in:151
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not create file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:152)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:152
   ! pio_async_decomp_tests_1d.F90.in:153
          ret = PIO_def_dim(pio_file, trim(dimname), dims(1), pio_dim)   ! pio_async_decomp_tests_1d.F90.in:154
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define dim :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:155)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:155
   ! pio_async_decomp_tests_1d.F90.in:156
          ret = PIO_def_var(pio_file, trim(vname), PIO_double, (/pio_dim/), pio_var)    ! pio_async_decomp_tests_1d.F90.in:157
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not define var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:158)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:158
   ! pio_async_decomp_tests_1d.F90.in:159
          ret = PIO_enddef(pio_file)   ! pio_async_decomp_tests_1d.F90.in:160
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not enddef in file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:161)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:161
   ! pio_async_decomp_tests_1d.F90.in:162
          call PIO_write_darray(pio_file, pio_var, iodesc, wbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:163
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Write darray failed :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:164)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:164
   ! pio_async_decomp_tests_1d.F90.in:165
#ifdef PIO_TEST_CLOSE_OPEN_FOR_SYNC
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:167
   ! pio_async_decomp_tests_1d.F90.in:168
          ret = PIO_openfile(iosys(gcomp_idx), pio_file, iotypes(j), trim(fnames(gcomp_idx)), PIO_nowrite)   ! pio_async_decomp_tests_1d.F90.in:169
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not reopen file :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:170)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:170
   ! pio_async_decomp_tests_1d.F90.in:171
          ret = PIO_inq_varid(pio_file, trim(vname), pio_var)   ! pio_async_decomp_tests_1d.F90.in:172
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could not inq var:" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:173)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:173
#else
          call PIO_syncfile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:175
#endif
   ! pio_async_decomp_tests_1d.F90.in:177
          rbuf = -1   ! pio_async_decomp_tests_1d.F90.in:178
          call PIO_read_darray(pio_file, pio_var, iodesc, rbuf, ret)   ! pio_async_decomp_tests_1d.F90.in:179
          
          IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  new_comm))) THEN
            call MPI_COMM_RANK( new_comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
            pio_tf_retval_utest_ = -1
            IF (pio_tf_tmp_comm_rank_ == 0) THEN
              PRINT *, "PIO_TF: PIO Function failed:",&
                 "Could read var :" // trim(fnames(gcomp_idx)),&
                ":", __FILE__, ":", __LINE__,&
                "(pio_async_decomp_tests_1d.F90.in:180)"
            END IF
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:180
   ! pio_async_decomp_tests_1d.F90.in:181
          ! FIXME: We don't have a PIO_TF_CHECK_VAL for a comm
          !PIO_TF_CHECK_VAL((rbuf, wbuf), "Got wrong val")
          
          IF (.NOT. (ALL(rbuf == wbuf))) THEN
            pio_tf_retval_utest_ = -1
            PRINT *, "PIO_TF: Assertion failed :",&
               "Got wrong val",&
               ":", __FILE__, ":", __LINE__,&
              "(pio_async_decomp_tests_1d.F90.in:184)"
            RETURN
          END IF   ! pio_async_decomp_tests_1d.F90.in:184
   ! pio_async_decomp_tests_1d.F90.in:185
          call PIO_closefile(pio_file)   ! pio_async_decomp_tests_1d.F90.in:186
          call PIO_deletefile(iosys(gcomp_idx), fnames(gcomp_idx))   ! pio_async_decomp_tests_1d.F90.in:187
        end do   ! pio_async_decomp_tests_1d.F90.in:188
        call PIO_freedecomp(iosys(gcomp_idx), iodesc)   ! pio_async_decomp_tests_1d.F90.in:189
   ! pio_async_decomp_tests_1d.F90.in:190
        do j=1,NUM_COMPONENTS   ! pio_async_decomp_tests_1d.F90.in:191
          call PIO_finalize(iosys(j), ret)   ! pio_async_decomp_tests_1d.F90.in:192
        end do   ! pio_async_decomp_tests_1d.F90.in:193
      end if   ! pio_async_decomp_tests_1d.F90.in:194
      call MPI_Comm_free(new_comm, ret)   ! pio_async_decomp_tests_1d.F90.in:195
      
      IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
        pio_tf_retval_utest_ = -1
        IF (pio_tf_world_rank_ == 0) THEN
          PRINT *, "PIO_TF: PIO Function failed:",&
             "PIO_init()/Finalize() failed",&
            ":", __FILE__, ":", __LINE__,&
            "(pio_async_decomp_tests_1d.F90.in:196)"
        END IF
        RETURN
      END IF   ! pio_async_decomp_tests_1d.F90.in:196
    end if   ! pio_async_decomp_tests_1d.F90.in:197
  end do   ! pio_async_decomp_tests_1d.F90.in:198
END SUBROUTINE async_2comp_wr_1d_PIO_double_real_kind_fc_double___   ! pio_async_decomp_tests_1d.F90.in:199
   ! pio_async_decomp_tests_1d.F90.in:199




  SUBROUTINE PIO_TF_Test_driver_
    USE pio_tutil
    IMPLICIT NONE
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_wr_1d_PIO_int_integer__"
    END IF
    CALL async_2comp_wr_1d_PIO_int_integer__()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "async_2comp_wr_1d_PIO_int_integer__","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "async_2comp_wr_1d_PIO_int_integer__","-----------", "FAILED"
      END IF
    END IF
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_wr_1d_PIO_real_real_kind_fc_real___"
    END IF
    CALL async_2comp_wr_1d_PIO_real_real_kind_fc_real___()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "async_2comp_wr_1d_PIO_real_real_kind_fc_real___","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "async_2comp_wr_1d_PIO_real_real_kind_fc_real___","-----------", "FAILED"
      END IF
    END IF
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting async_2comp_wr_1d_PIO_double_real_kind_fc_double___"
    END IF
    CALL async_2comp_wr_1d_PIO_double_real_kind_fc_double___()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          "async_2comp_wr_1d_PIO_double_real_kind_fc_double___","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          "async_2comp_wr_1d_PIO_double_real_kind_fc_double___","-----------", "FAILED"
      END IF
    END IF
  END SUBROUTINE PIO_TF_Test_driver_


  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
